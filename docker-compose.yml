services:
  api:
    build: ./api
    deploy:
      replicas: 3
    environment:
      - USE_REDIS=true
      - MAX_INFLIGHT=400
    depends_on:
      scylladb:
        condition: service_healthy
      scylla-init:
        condition: service_completed_successfully
      redis:
        condition: service_started
    ports:
      - "3000:3000"

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  scylladb:
    image: scylladb/scylla:5.4
    command: --smp 2 --memory 1G
    ports:
      - "9042:9042"
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'describe keyspaces' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  scylla-init:
    image: scylladb/scylla:5.4
    depends_on:
      scylladb:
        condition: service_healthy
    volumes:
      - ./scylla/init.cql:/init.cql
      - ./scylla/init.sh:/init.sh
    entrypoint: ["/bin/bash", "/init.sh"]
    restart: "no"

  k6:
    image: grafana/k6
    depends_on:
      - api
    volumes:
      - ./load-tests:/scripts
    command: run /scripts/tatkal-spike.js

  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana
    ports:
      - "3001:3000"